<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Consul - leela-@version@</title>
  

  <link rel="shortcut icon" href="../../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Consul";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> leela-@version@</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../..">Home</a>
        
    </li>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>User</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../user/http-interface/">Http interface</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../user/leela-query-language/">Leela query language</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Devel</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../../devel/environment/">Environment</a>
        
    </li>

        
    </ul>
<li>
          
            <li>
    <ul class="subnav">
    <li><span>Admin</span></li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../cassandra/">Cassandra</a>
        
    </li>

        
            
    <li class="toctree-l1 current">
        <a class="current" href="./">Consul</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#consul">CONSUL</a></li>
                
                    <li><a class="toctree-l4" href="#upgrade">UPGRADE</a></li>
                
                    <li><a class="toctree-l4" href="#cluster-info">CLUSTER INFO</a></li>
                
                    <li><a class="toctree-l4" href="#adding-instances">ADDING INSTANCES</a></li>
                
                    <li><a class="toctree-l4" href="#removing-instance">REMOVING INSTANCE</a></li>
                
                    <li><a class="toctree-l4" href="#config-files">CONFIG FILES</a></li>
                
                    <li><a class="toctree-l4" href="#service-files">SERVICE FILES</a></li>
                
                    <li><a class="toctree-l4" href="#bootstraping-a-new-cluster">BOOTSTRAPING A NEW CLUSTER</a></li>
                
            
            </ul>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../install-leela/">Install leela</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../packaging-leela/">Packaging leela</a>
        
    </li>

        
            
    <li class="toctree-l1 ">
        <a class="" href="../redis/">Redis</a>
        
    </li>

        
    </ul>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">leela-@version@</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Admin &raquo;</li>
        
      
    
    <li>Consul</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="consul">CONSUL</h1>
<p>Consul operation guide. Consul is used for service discovery. Leela
discover the machines by reading that information from consul.</p>
<h2 id="upgrade">UPGRADE</h2>
<p>First upgrade the servers, one by one. After that you may upgrade the
clients, again, one at a time.</p>
<h2 id="cluster-info">CLUSTER INFO</h2>
<ul>
<li><code>consul members</code>                              # returns the cluster members and its status</li>
<li><code>curl http://localhost:8500/v1/status/peers</code>  # current raft peers [usually three];</li>
<li><code>curl http://localhost:8500/v1/status/leader</code> # <em>must</em> return exactly one;</li>
</ul>
<h2 id="adding-instances">ADDING INSTANCES</h2>
<ol>
<li>make sure the directory <code>/etc/consul/conf.d</code> and the file
   <code>/etc/consul/config</code> are properly configure. That file should come
   from CFengine.</li>
<li><code>/etc/init.d/consul start</code></li>
</ol>
<h2 id="removing-instance">REMOVING INSTANCE</h2>
<p>Since the consul monitors a machine and all its services, if you ever
remove an instance you must also remove all of its services. Follow
the procedure to stop and remove every service individually and then
simply stops consul:</p>
<ol>
<li><code>/etc/init.d/consul stop</code></li>
</ol>
<h2 id="config-files">CONFIG FILES</h2>
<ul>
<li><code>/etc/consul/config</code></li>
</ul>
<h2 id="service-files">SERVICE FILES</h2>
<p>If you ever change any of these files, issue <code>consul reload</code> to apply
the changes.</p>
<ul>
<li><code>/etc/consul/conf.d/*.service</code></li>
</ul>
<h2 id="bootstraping-a-new-cluster">BOOTSTRAPING A NEW CLUSTER</h2>
<p>All machines have died, somehow! Then you need to put the cluster back
on:</p>
<ol>
<li><code>env CONSUL_EXTRA_OPTS="-bootstrap" /etc/init.d/consul start</code></li>
</ol>
<p>Wait this instance to get back online. It should be the sole instance
thus the leader. Now you can put the rest online normally
[the dns should be working too].</p>
<ol>
<li><code>/etc/init.d/consul start</code></li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../install-leela/" class="btn btn-neutral float-right" title="Install leela"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../cassandra/" class="btn btn-neutral" title="Cassandra"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../cassandra/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../install-leela/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
